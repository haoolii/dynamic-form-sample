<div class="rule-manager">
      <!-- Â∑¶ÂÅ¥: Type List -->
      <div class="sidebar">
        <h3>Rule Types</h3>
        <ul class="type-list">
          @for (type of typeList(); track type) {
            <li
              [class.active]="selectedType() === type"
              (click)="selectType(type)">
              <span class="type-name">
                @if (isTypeDirty(type)) {
                  <span class="dirty-indicator"></span>
                }
                {{ type }}
              </span>
              @if (hasRules(type)) {
                <span class="badge">{{ getRuleCount(type) }}</span>
              }
            </li>
          }
        </ul>

        <!-- ÂÖ®ÂüüÊìç‰ΩúÊåâÈàï -->
        <div class="sidebar-actions">
          <button
            class="btn-success btn-block"
            [disabled]="!isFormDirty()"
            (click)="saveAllRules()">
            üíæ ÂÑ≤Â≠òÂÖ®ÈÉ®
          </button>
          <button
            class="btn-secondary btn-block"
            [disabled]="!isFormDirty()"
            (click)="resetAllRules()">
            ‚Ü∫ ÈáçÁΩÆÂÖ®ÈÉ®
          </button>
        </div>
      </div>

      <!-- Âè≥ÂÅ¥: Form -->
      <div class="content">
        @if (selectedType(); as type) {
          <div class="form-header">
            <h2>
              {{ type }}
              @if (isTypeDirty(type)) {
                <span class="dirty-badge">Â∑≤‰øÆÊîπ</span>
              }
            </h2>
            @if (!hasRules(type)) {
              <button class="btn-primary" (click)="createNewRule(type)">
                + Êñ∞Â¢ûÁ¨¨‰∏ÄÁ≠ÜË¶èÂâá
              </button>
            }
          </div>

          @if (mainForm.controls[type]; as typeForm) {
            <div class="rule-form">
              <!-- Root Level Controls -->
              <div class="root-controls">
                <label>
                  <input type="checkbox" [formControl]="typeForm.controls.enabled">
                  ÂïüÁî®Ë¶èÂâá
                </label>
                <span class="operator-badge">{{ typeForm.controls.operator.value }}</span>
              </div>

              <!-- AND Groups (FormArray) -->
              <div class="and-groups">
                @for (orGroup of getOrGroups(typeForm); track orGroup; let i = $index) {
                  <div class="or-group-wrapper">
                    <div class="group-header">
                      <div class="group-controls">
                        <label>
                          <input type="checkbox" [formControl]="orGroup.controls.enabled">
                          ÂïüÁî®Áæ§ÁµÑ #{{ i + 1 }}
                        </label>
                        <span class="operator-badge or">OR</span>
                      </div>
                      <button
                        type="button"
                        class="btn-danger btn-sm"
                        (click)="removeOrGroup(type, i)">
                        Âà™Èô§Áæ§ÁµÑ
                      </button>
                    </div>

                    <!-- OR Group Rules -->
                    <div class="rules-list">
                      @for (rule of getConditions(orGroup); track rule; let j = $index) {
                        <div class="rule-item">
                          <label class="checkbox">
                            <input type="checkbox" [formControl]="rule.controls.enabled">
                          </label>

                          <select [formControl]="rule.controls.field" class="field-select">
                            <option value="">ÈÅ∏ÊìáÊ¨Ñ‰Ωç</option>
                            <option value="assigen">Assigen</option>
                            <option value="comment">Comment</option>
                            <option value="user">User</option>
                            <option value="status">Status</option>
                            <option value="priority">Priority</option>
                          </select>

                          <select [formControl]="rule.controls.operator" class="operator-select">
                            <option value="EQ">Á≠âÊñº (=)</option>
                            <option value="!EQ">‰∏çÁ≠âÊñº (‚â†)</option>
                            <option value="CTN">ÂåÖÂê´</option>
                            <option value="GT">Â§ßÊñº (>)</option>
                            <option value="LT">Â∞èÊñº (<)</option>
                          </select>

                          <input
                            type="text"
                            [formControl]="rule.controls.value"
                            placeholder="Ëº∏ÂÖ•ÂÄº"
                            class="value-input">

                          <button
                            type="button"
                            class="btn-danger btn-icon"
                            (click)="removeCondition(type, i, j)">
                            ‚úï
                          </button>
                        </div>
                      }

                      <button
                        type="button"
                        class="btn-secondary btn-sm"
                        (click)="addCondition(type, i)">
                        + Êñ∞Â¢ûÊ¢ù‰ª∂
                      </button>
                    </div>
                  </div>
                }
              </div>

              <!-- Add OR Group Button -->
              <button
                type="button"
                class="btn-primary"
                (click)="addOrGroup(type)">
                + Êñ∞Â¢û OR Áæ§ÁµÑ
              </button>

              <!-- Actions -->
              <div class="form-actions">
                <button
                  type="button"
                  class="btn-danger"
                  (click)="deleteRule(type)">
                  Âà™Èô§Ê≠§Ë¶èÂâá
                </button>
              </div>
            </div>
          }
        } @else {
          <div class="empty-state">
            <p>Ë´ãÂæûÂ∑¶ÂÅ¥ÈÅ∏Êìá‰∏ÄÂÄãË¶èÂâáÈ°ûÂûã</p>
          </div>
        }
      </div>

      <pre>
        {{ mainForm.value | json }}
      </pre>
    </div>
